name: Deploy Hugo site to Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1) 소스 체크아웃
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Hugo Extended 설치 (SCSS 파이프라인 지원)
      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'    # 원하면 고정 버전으로
          extended: true

      # 3) Dart Sass Embedded 설치 (폴더 그대로 + PATH 추가)
      #    ※ dart-sass-embedded는 Ubuntu 24.04 APT에 없음 → 릴리스 tar.gz 사용
      - name: Install Dart Sass Embedded (linux-x64)
        run: |
          set -euxo pipefail
          ver=1.62.1
          url="https://github.com/sass/dart-sass-embedded/releases/download/${ver}/sass_embedded-${ver}-linux-x64.tar.gz"

          curl -fSL "$url" -o /tmp/sass_embedded.tgz
          tar -xzf /tmp/sass_embedded.tgz -C /tmp

          # 폴더 통째로 보존 (상대경로 의존 때문에 반드시 폴더째 필요)
          sudo mv /tmp/sass_embedded /opt/dart-sass-embedded

          # 이 디렉터리를 PATH에 추가 (심볼릭 링크 대신 디렉터리 PATH 권장)
          echo "/opt/dart-sass-embedded" >> "$GITHUB_PATH"

          # 동작 확인 (같은 폴더 안의 보조 파일 접근 가능해야 함)
          dart-sass-embedded --version

      # 4) Hugo Modules 캐시
      - name: Cache Hugo Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/hugo_mod
            **/go.sum
          key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.mod') }}
          restore-keys: ${{ runner.os }}-hugomod-

      # (선택) 환경 진단 로그
      - name: Hugo env
        run: hugo env

      # 5) 빌드
      - name: Build
        run: hugo --minify

      # 6) Pages 아티팩트 업로드(전용 액션)
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

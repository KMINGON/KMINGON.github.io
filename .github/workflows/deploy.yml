name: Deploy Hugo site to Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Setup Hugo (extended)
      - name: Setup Hugo (extended)
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # 3) Install Dart Sass Embedded (linux-x64)
      - name: Install Dart Sass Embedded (linux-x64)
        run: |
          set -euxo pipefail
          ver=1.62.1
          url="https://github.com/sass/dart-sass-embedded/releases/download/${ver}/sass_embedded-${ver}-linux-x64.tar.gz"
          curl -fSL "$url" -o /tmp/sass_embedded.tgz
          tar -xzf /tmp/sass_embedded.tgz -C /tmp
          sudo mv /tmp/sass_embedded /opt/dart-sass-embedded
          sudo chmod +x /opt/dart-sass-embedded/dart-sass-embedded
          echo /opt/dart-sass-embedded >> "$GITHUB_PATH"
          # 같은 스텝에서는 PATH 전파가 안 되므로 절대경로로 검증
          /opt/dart-sass-embedded/dart-sass-embedded --version

      # 4) Cache Hugo Modules
      - name: Cache Hugo Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/hugo_mod
            **/go.sum
          key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.mod') }}
          restore-keys: ${{ runner.os }}-hugomod-

      # 5) (Optional) env 출력
      - name: Hugo env
        run: hugo env

      # 6) Build
      - name: Build
        run: hugo --minify

      # 7) Upload Pages artifact (전용 액션)
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      # 아래 URL은 deploy 스텝의 출력 사용. 구문/ID 일치 필수!
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
